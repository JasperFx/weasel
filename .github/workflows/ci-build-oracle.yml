name: Oracle CI build

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

env:
  config: Release
  disable_test_parallelization: true
  DOTNET_CLI_TELEMETRY_OPTOUT: 1
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
  db_pwd: P@55w0rd

jobs:
  build:

    runs-on: ubuntu-latest
    timeout-minutes: 45

    strategy:
        # define the test matrix
        matrix:
            oracle-image:
                - gvenzl/oracle-free:23-slim
            framework:
                - net8.0
                - net9.0
                - net10.0

    name: Oracle ${{ matrix.oracle-image }} ${{ matrix.framework }}

    services:
      oracle:
        image: ${{ matrix.oracle-image }}
        ports:
          - 1521:1521
        env:
          ORACLE_PASSWORD: ${{ env.db_pwd }}
          APP_USER: weasel
          APP_USER_PASSWORD: ${{ env.db_pwd }}
        options: >-
          --health-cmd healthcheck.sh
          --health-interval 30s
          --health-timeout 30s
          --health-retries 10

    steps:
    - uses: actions/checkout@v6

    - name: Grant Oracle permissions
      run: |
        # Find the Oracle container ID
        ORACLE_CONTAINER=$(docker ps --filter "ancestor=${{ matrix.oracle-image }}" --format "{{.ID}}")
        # Copy the init script to the container
        docker cp docker/oracle/init-weasel-permissions.sql $ORACLE_CONTAINER:/tmp/init-weasel-permissions.sql
        # Execute the script as SYSTEM user connected to root container (CDB)
        # The script uses ALTER SESSION SET CONTAINER to switch to FREEPDB1
        docker exec $ORACLE_CONTAINER sqlplus -s SYSTEM/${{ env.db_pwd }}@//localhost:1521/FREE @/tmp/init-weasel-permissions.sql

    - name: Install .NET
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: |
            8.0.x
            9.0.x
            10.0.x

    - name: Restore dependencies
      run: dotnet restore

    - name: Build
      run: dotnet build --no-restore

    - name: Test
      env:
        weasel_oracle_testing_database: "Data Source=localhost:1521/FREEPDB1;User Id=weasel;Password=${{ env.db_pwd }};"
      run: dotnet test src/Weasel.Oracle.Tests/Weasel.Oracle.Tests.csproj --no-build --verbosity normal --framework ${{ matrix.framework }}
